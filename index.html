<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="My personal blog on scientific computing, science and related topics">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Björn I. Dahlgren's personal page</title>
<link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="assets/css/code.css" rel="stylesheet" type="text/css">
<link href="assets/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://bjodah.github.io/blog/index.html">
<link rel="next" href="index-1.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/gsoc-report.html" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://bjodah.github.io/blog/">

                <span id="blog-title">Björn I. Dahlgren's personal page</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/index.html">Tags</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    
<div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/gsoc-report.html" class="u-url">GSoC 2017 Report</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Björn Dahlgren
            </span></p>
            <p class="dateline"><a href="posts/gsoc-report.html" rel="bookmark"><time class="published dt-published" datetime="2017-08-28T21:15:00+02:00" title="2017-08-28 21:15">2017-08-28 21:15</time></a></p>
                <p class="commentline">
        
    <a href="posts/gsoc-report.html#disqus_thread" data-disqus-identifier="cache/posts/170829-gsoc.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<div class="section" id="introduction">
<h2>Introduction</h2>
<p>My project was to enhance the code-generation facilities of SymPy.
You can read my <a class="reference external" href="https://github.com/sympy/sympy/wiki/GSoC-2017-Application-Bj%C3%B6rn-Dahlgren:-Improved-code-generation-facilities">proposal</a>
for the motivation behind this work. The overall goals were the
following:</p>
<ul class="simple">
<li>Allow to render code targeting a specific precision (e.g. binary32
vs. binary64 floating point numbers). Prior to this project the
printers would sometimes generate code containing a mixture of single,
double and extended precision, and there were no way to change this
short of subclassing the printers and overriding the methods.</li>
<li>Allow to render blocks of code and not only expressions. There was
an initial effort to support this in the submodule
<tt class="docutils literal">sympy.codegen</tt>.</li>
<li>Improve the <tt class="docutils literal">Lambdify</tt> functionality in SymEngine's python
wrapper. Before this project it did not handle outputs of mixed
shape, and it also had considerable overhead.</li>
</ul>
</div>
<div class="section" id="summary-of-the-final-work-product">
<h2>Summary of the final work product</h2>
<p>A whole new repository with code and notebooks for code-generation was
created during the first part of GSoC:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/sympy/scipy-2017-codegen-tutorial">https://github.com/sympy/scipy-2017-codegen-tutorial</a></li>
</ul>
<p>Jason Moore, Kenneth Lyons, Aaron Meurer and I (my <a class="reference external" href="https://github.com/sympy/scipy-2017-codegen-tutorial/commits/master?author=bjodah">commits</a>) created this for the
tutorial in code generation with SymPy at the SciPy 2017 conference.</p>
<p>The majority of the work are contained in these pull-requests:</p>
<ul class="simple">
<li>symengine.py, <a class="reference external" href="https://github.com/symengine/symengine.py/pull/112">#112</a> (merged):
Heterogeneous output in Lambdify.</li>
<li>symengine.py, <a class="reference external" href="https://github.com/symengine/symengine.py/pull/171">#171</a> (merged):
Bug fix for heterogeneous output in Lambdify.</li>
<li>sympy, <a class="reference external" href="https://github.com/sympy/sympy/pull/12693">#12693</a>
(merged): Extending the <tt class="docutils literal">sympy.codegen.ast</tt> module with new
classes (for generating ASTs).</li>
<li>sympy, <a class="reference external" href="https://github.com/sympy/sympy/pull/12808">#12808</a>
&amp; <a class="reference external" href="https://github.com/sympy/sympy/pull/13046">#13046</a> (merged):
PythonCodePrinter, MpmathPrinter, SymPyPrinter NumPyPrinter, SciPyPrinter.</li>
<li>sympy, <a class="reference external" href="https://github.com/sympy/sympy/pull/13063">#13194</a> (open):
Add <tt class="docutils literal">.codegen.rewriting</tt> module.</li>
<li>sympy, <a class="reference external" href="https://github.com/sympy/sympy/pull/13200">#13200</a> (merged):
Add <tt class="docutils literal">.codegen.approximations</tt> module.</li>
<li>sympy, <a class="reference external" href="https://github.com/sympy/sympy/pull/13100">#13100</a> (open):
More AST nodes. Building on #12693, this is the biggest PR. In
addition to improving the AST nodes it introduces
<tt class="docutils literal">.codegen.algorithms</tt> as well as an internal testing module
<tt class="docutils literal">.utilities._compilation</tt> which allows to compile and import/run
strings of C/C++/Fortran code.</li>
</ul>
<p>In addition there were smaller pull-requests made &amp; merged:</p>
<ul class="simple">
<li>sympy_benchmarks: <a class="reference external" href="https://github.com/sympy/sympy_benchmarks/pull/37">#37</a>,
<a class="reference external" href="https://github.com/sympy/sympy_benchmarks/pull/38">#38</a>,
<a class="reference external" href="https://github.com/sympy/sympy_benchmarks/pull/39">#39</a>,
<a class="reference external" href="https://github.com/sympy/sympy_benchmarks/pull/40">#40</a>:
Benchmarks for lambidfy and common sub-expression elimination.</li>
<li>sympy: <a class="reference external" href="https://github.com/sympy/sympy/pull/12686">#12686</a>
(Support for __abs__ in SymPy matrices),
<a class="reference external" href="https://github.com/sympy/sympy/pull/12692">#12692</a> (subclass support for
SymPy's deprecation decorator), <a class="reference external" href="https://github.com/sympy/sympy/pull/12762">#12762</a> (Fix floating point
error under windows),
<a class="reference external" href="https://github.com/sympy/sympy/pull/12805">#12805</a> Revert change to
cse (performance regression), <a class="reference external" href="https://github.com/sympy/sympy/pull/12764">#12764</a> environment variable use,
<a class="reference external" href="https://github.com/sympy/sympy/pull/12883">#12833</a> string formatting,
<a class="reference external" href="https://github.com/sympy/sympy/pull/12944">#12944</a> allow relative
path in autowrap,
<a class="reference external" href="https://github.com/sympy/sympy/pull/13063">#13063</a> fix test timing script
(and updated timings),
<a class="reference external" href="https://github.com/sympy/sympy/pull/12833">#12833 (some of the commits)</a> Allow custom class
in autowrap &amp; codegen,
<a class="reference external" href="https://github.com/sympy/sympy/pull/12843">#12843 (one of the commits)</a> allow changing compile
arguments in <tt class="docutils literal">CythonCodeWrapper</tt>.</li>
</ul>
</div>
<div class="section" id="detailed-review-of-the-work">
<h2>Detailed review of the work</h2>
<p>The first weeks of the summer was mostly spent on the code generation
material presented at the SciPy conference tutorial, in parallel with
that work was done to handle different choices of data types in the
printers. And new AST nodes were introduced to represent type.</p>
<div class="section" id="code-for-the-tutorial">
<h3>Code for the tutorial</h3>
<p>During the writing of this code improvements were made to the existing
code-generation facilities and SymPy (and experience with their
shortcomings were gained). One of the challenges in this work was that
the attendees at the conference would be using all major platforms
(Linux/macOS/Windows) and different Python versions, we needed to
ensure that generating code, compiling, linking and importing worked
all combinations.</p>
</div>
<div class="section" id="lambdify-in-symengine-s-python-wrapper">
<h3>Lambdify in SymEngine's python wrapper</h3>
<p>Writing the code for the tutorial provided great test cases for the
code-generation capabilities of SymPy. The motivation of doing code
generation is usually that of speed (but sometimes it may be motivated
by wanting to work with some library written in another language). An
alternative to generating high level code which then gets compiled, is
to go toward assembly (or some intermediate representation). SymEnigne
had support for doing this via LLVM's JIT compiler. The Python
bindings however needed an overhaul (something I had included in the
time-line in my proposal), and now I wanted to use <tt class="docutils literal">Lambdify</tt> (the
SymEngine version of <tt class="docutils literal">sympy.lambdify</tt>), and together with the help
of Isuru Fernando we got it to work (and benchmarks for <a class="reference external" href="https://pydy.org">pydy</a> show that it is even faster than using the cython
backend).</p>
</div>
<div class="section" id="ast-nodes">
<h3>AST nodes</h3>
<p>I had made AST nodes in my prototype for my proposal, right at the
start of the project I ported those to SymPy. It took some rewriting
and discussion with Aaron (both during our weekly meetings and at the
conference) to get it to a point where we were confident enough to
merge it into SymPy's codebase.</p>
<p>One of the major challanges when designing the new classes for
<tt class="docutils literal">sympy.codegen.ast</tt> was dealing with optional arguments in our
subclasses of <tt class="docutils literal">symyp.core.basic.Basic</tt>. The solutions which worked
best was to have a subclass <tt class="docutils literal">sympy.codegen.Node</tt> which stored such
optinoal information as instances in a SymPy <tt class="docutils literal">Tuple</tt> as its last
argument (accessible as <tt class="docutils literal"><span class="pre">.attrs`).</span> This allowed the code
printers for Python, C and Fortran to support the same ``Variable</tt> class
for instance, where the C printer would also look for attributes
"value_const", "volatile" etc. and the Fortran printer would look for
e.g. "intent".</p>
<p>Language specific nodes have been added under their own submodules in
<tt class="docutils literal">sympy.codegen</tt> (e.g. <tt class="docutils literal">sympy.codegen.fnodes</tt> for Fortran and
<tt class="docutils literal">sympy.codegen.cnodes</tt> for C). The most common statements are now
implmeneted, but the nodes are by far not exhaustive. There are now
also helper functions for generating e.g. modules in
<tt class="docutils literal">sympy.codegen.pyutils</tt> &amp; <tt class="docutils literal">sympy.codegen.futils</tt> (for Python and
Fortran respectively).</p>
</div>
<div class="section" id="code-printers">
<h3>Code printers</h3>
<p>Dealing with floating point types is
tricky since one want to be pragmatic in order for the types to be
helpful (IEEE 754 conformance is assumed), but general enough that
people targeting hardware with non-standard conformance can still
generate useful code using SymPy. For example, one can now choose
the targeted precision:</p>
<pre class="literal-block">
&gt;&gt;&gt; from sympy import ccode, symbols, Rational
&gt;&gt;&gt; x, tau = symbols("x, tau")
&gt;&gt;&gt; expr = (2*tau)**Rational(7, 2)
&gt;&gt;&gt; from sympy.codegen.ast import real, float80
&gt;&gt;&gt; ccode(expr, type_aliases={real: float80})
'8*M_SQRT2l*powl(tau, 7.0L/2.0L)'
</pre>
<p>Here we have assumed that the targeted architechture has x87 FPU (long
double is a 10 byte extended precision floating point data type). But
it is fully possible to generate code for some other targeted
precision, e.g. GCC's software implemented float128:</p>
<pre class="literal-block">
&gt;&gt;&gt; from sympy.printing.ccode import C99CodePrinter
&gt;&gt;&gt; from sympy.codegen.ast import FloatType
&gt;&gt;&gt; f128 = FloatType('_Float128', 128, nmant=112, nexp=15)
&gt;&gt;&gt; p128 = C99CodePrinter(dict(
...     type_aliases={real: f128},
...     type_literal_suffixes={f128: 'Q'},
...     type_func_suffixes={f128: 'f128'},
...     type_math_macro_suffixes={
...         real: 'f128',
...         f128: 'f128'
...     },
...     type_macros={
...         f128: ('__STDC_WANT_IEC_60559_TYPES_EXT__',)
...     },
...     math_macros={}
... ))
&gt;&gt;&gt; p128.doprint(tau**Rational(7, 2))
'powf128(tau, 7.0Q/2.0Q)'
</pre>
<p>For generating Python code there was previosuly one function
(<tt class="docutils literal">sympy.printing.python</tt>) which generated code dependent on SymPy.
During the project a proper code printer for Python was introduced
(an example of its output is shown later). The much used function
<tt class="docutils literal">lambdify</tt> was also changed to use this new printer. Introducing
such a big change without breaking backward compatibility was
certainly a challenge, but the benefit is that the user may now
subclass the printers to override their default behaviour and use
their custom printer in <tt class="docutils literal">lambdify</tt>.</p>
</div>
<div class="section" id="rewriting">
<h3>Rewriting</h3>
<p>One usual challenge when working with symbolic expressions is that
there are many ways to write the same expresisons. For code-generation
purposes we want to write it in a manner which maximizes performance
and minimizes significance loss (or let the user make that choice when
the two are at odds). Since SymPy already has a great tools for
traversing the expression tree and applying quite advanced pattern
matching based replacements using <tt class="docutils literal">Wild</tt> it was reasonably
straightforward to implement rewriting rules for transforming e.g.
<tt class="docutils literal"><span class="pre">2**x</span></tt> to <tt class="docutils literal">exp2(x)</tt> etc. Using the same structure, rules for
rewriting expressions to drop small elements in sums (based on a
user-predefined bounds).</p>
</div>
<div class="section" id="algorithms">
<h3>Algorithms</h3>
<p>One of the great benefitst from being able to represent abstract
syntax trees as (largetly) language agnostic SymPy obejcts is that we
can create functions for building these trees. Simpler numerical
algorithms (which are ubiquitous in scientific codes) can be collected
under <tt class="docutils literal">sympy.codegen.algorithms</tt>. As a first case Newton's
algortihm was implemented:</p>
<pre class="literal-block">
&gt;&gt;&gt; from sympy import cos
&gt;&gt;&gt; from sympy.codegen.algorithms import newtons_method_function
&gt;&gt;&gt; ast = newtons_method_function(cos(x) - x**3, x)
&gt;&gt;&gt; print(ccode(ast))
double newton(double x){
   double d_x = INFINITY;
   while (fabs(d_x) &gt; 9.9999999999999998e-13) {
      d_x = (pow(x, 3) - cos(x))/(-3*pow(x, 2) - sin(x));
      x += d_x;
   }
   return x;
}
</pre>
<p>once we have the AST we can print it using the python code printer as well:</p>
<pre class="literal-block">
&gt;&gt;&gt; from sympy.printing import pycode
&gt;&gt;&gt; print(pycode(ast))
def newton(x):
    d_x = float('inf')
    while abs(d_x) &gt; 1.0e-12:
        d_x = (x**3 - math.cos(x))/(-3*x**2 - math.sin(x))
        x += d_x
    return x
</pre>
<p>or the Fortran code printer:</p>
<pre class="literal-block">
&gt;&gt;&gt; from sympy.printing import fcode
&gt;&gt;&gt; print(fcode(ast, source_format='free', standard=2003))
real*8 function newton(x)
real*8 :: x
real*8 :: d_x = (huge(0d0) + 1)
do while (abs(d_x) &gt; 1.0d-12)
   d_x = (x**3 - cos(x))/(-3*x**2 - sin(x))
   x = x + d_x
end do
newton = x
end function
</pre>
<p>Newton's method is quite simple, but what makes SymPy suitable for
this is that it needs the ratio between the function and its
derivative.</p>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>I think that I managed to address all parts of my proposal. That being
said, there is still a lot of potential to expand the
<tt class="docutils literal">sympy.codegen</tt> module. But now there are purposefully made base
classes for creating AST node classes (<tt class="docutils literal">sympy.codegen.ast.Token</tt> &amp;
<tt class="docutils literal">sympy.codegen.ast.Node</tt>), the language agnostic ones are general enough
that an algorithm represented as a single AST can be printed as
Python/C/Fortran. At some level code will still be needed to be
written manually (presumably as templates), but the amount of template
rendering logic can be significantly reduced. Having algorithm AST
factories such as the one for Newton's method in
<tt class="docutils literal">sympy.codegen.ast.algorithms</tt> is also exciting since those
algorithms can be unit-tested as part of SymPy. Ideas for furthor work
on code-generation with SymPy have been added to <a class="reference external" href="https://github.com/sympy/sympy/wiki/GSoC-2018-Ideas#code-generation">the list</a>
of potential ideas for next years GSoC.</p>
</div>
<div class="section" id="post-gsoc">
<h2>Post-GSoC</h2>
<p>I plan to continue to contribute to the SymPy project, and start using
the new resources in my own research. Working with the new classes
should also allow us to refine them if needed (preferably before the
next release is tagged in order to avoid having to introduce
deprecation cycles). SymPy is an amazing project with
a great community. I'm really grateful to Google for funding me (and
others) to do a full summers work on this project.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/gsoc-week13.html" class="u-url">Status update week 13 GSoC</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Björn Dahlgren
            </span></p>
            <p class="dateline"><a href="posts/gsoc-week13.html" rel="bookmark"><time class="published dt-published" datetime="2017-08-28T21:15:00+02:00" title="2017-08-28 21:15">2017-08-28 21:15</time></a></p>
                <p class="commentline">
        
    <a href="posts/gsoc-week13.html#disqus_thread" data-disqus-identifier="cache/posts/170828-w13.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>This was the last week of work on GSoC. I have been hard at work
improving documentation and examples for the code.</p>
<div class="section" id="adding-much-needed-documentaiton">
<h2>Adding much needed documentaiton</h2>
<p>I've spent the weekend adding examples and writing up documentation
for my big PR <a class="reference external" href="https://github.com/sympy/sympy/pull/13100">#13100</a>
which is not yet merged. I am quite excited how this PR turned out and
I am happy with the design of the underlying AST nodes.</p>
</div>
<div class="section" id="rewriting">
<h2>Rewriting</h2>
<p>A new submodule <tt class="docutils literal">.codegen.rewriting</tt> was added (in <a class="reference external" href="https://github.com/sympy/sympy/pull/13194">#13194</a>), this allows a user to
rewrite expressions using special math functions. The provided rules
are those to rewrite to C99's special math functions (<tt class="docutils literal">expm1</tt>,
<tt class="docutils literal">log1p</tt> etc.). I think it will be a useful addition (I have myself
had the need for exactly this in my own research). The design is quite
simple thanks to the excellt <tt class="docutils literal">replace</tt> function in SymPy. There are
still some corner cases (I have an "xfailed" test checked in for
example).</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/gsoc-week12.html" class="u-url">Status update week 12 GSoC</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Björn Dahlgren
            </span></p>
            <p class="dateline"><a href="posts/gsoc-week12.html" rel="bookmark"><time class="published dt-published" datetime="2017-08-21T19:30:00+02:00" title="2017-08-21 19:30">2017-08-21 19:30</time></a></p>
                <p class="commentline">
        
    <a href="posts/gsoc-week12.html#disqus_thread" data-disqus-identifier="cache/posts/170821-w12.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<div class="section" id="working-on-new-ast-nodes">
<h2>Working on new AST nodes</h2>
<p><a class="reference external" href="https://github.com/sympy/sympy/pull/13100">#13100</a> is shaping up to
be the largest PR of my GSoC project. The design of the new AST nodes
especially (<tt class="docutils literal">Token</tt>) is really helpful. But there is still a design
issue: some nodes would naturally take different arguments depending
on what language is being targeted. So I came to the conclusion that I
needed some way of representing attributes. The solution I came up
with would be to have a slightly more capable <tt class="docutils literal">Node</tt> class
(subclassing <tt class="docutils literal">Token</tt>) which would in turn be subclassed from for
nodes that need attributes.</p>
<p>I also enhanced the printing of both of these classes and introduced a
<tt class="docutils literal">String</tt> class, which in contrast to <tt class="docutils literal">Symbol</tt> does not accept
assumptions in its constructor, and does not have implied printing
rules of sub- &amp; superscript etc.</p>
</div>
<div class="section" id="adding-codegen-algorithms">
<h2>Adding <tt class="docutils literal">.codegen.algorithms</tt>
</h2>
<p>A new submodule <tt class="docutils literal">.codegen.algorithms</tt> was added, containing a AST
generating function for Newton's method. This makes a nice design
target for both the printers and AST nodes: being able to express the
same AST in differnt languages is definitely an indication that we
have a versatile printing system.</p>
</div>
<div class="section" id="compiling-code-on-the-fly">
<h2>Compiling code on the fly</h2>
<p>Introducing the <tt class="docutils literal">.codegen.algorithms</tt> module also made the need to
test generated code during CI runs clear. Jason Moore has previously
mentioned that he thinks one of my python packages (<a class="reference external" href="https://github.com/bjodah/pycompilation">pycompilation</a>) would fit nicely into
SymPy. I've been a bit relucatant to port it over since I have felt
that it has not seen enough testing (and only under Linux). But now
there was a need and we could start by making it an internal package
only used by our own tests. That way it will get to mature without
having to worry about deprecation cycles. And once more platforms are
added to SymPy's CI configuration it would also see testing on other
platforms (using AppVeyor for SymPy has been discussed for a long
while now).</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/gsoc-week11.html" class="u-url">Status update week 11 GSoC</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Björn Dahlgren
            </span></p>
            <p class="dateline"><a href="posts/gsoc-week11.html" rel="bookmark"><time class="published dt-published" datetime="2017-08-14T20:17:00+02:00" title="2017-08-14 20:17">2017-08-14 20:17</time></a></p>
                <p class="commentline">
        
    <a href="posts/gsoc-week11.html#disqus_thread" data-disqus-identifier="cache/posts/170814-w11.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<div class="section" id="checking-in-the-new-ast-node-types">
<h2>Checking in the new AST node types</h2>
<p><a class="reference external" href="https://github.com/sympy/sympy/pull/12693">#12693</a> got merged 🎉.
It took a few rewrites essentially but I fell that the design of the
new nodes will allow us to scale with reasonable maintance cost when
adding new language specific nodes. The base class for new AST nodes
(<tt class="docutils literal">Token</tt>) to sublcass from allows one to implement nodes in an
expressive manner by setting <tt class="docutils literal">__slots__</tt>. The constructor of
<tt class="docutils literal">Token</tt> then sets the <tt class="docutils literal">.args</tt> of <tt class="docutils literal">Basic</tt> based on <tt class="docutils literal">__slots__</tt>
this has the benefit that you need not write setters and getters using
<tt class="docutils literal">@property</tt> decorators (which quickly becomes tiresome when you have
many classes).</p>
</div>
<div class="section" id="checking-in-the-refactored-pythonprinter-and-changes-to-lambdify">
<h2>Checking in the refactored PythonPrinter and changes to lambdify</h2>
<p>Finally the challenging work of refactoring <tt class="docutils literal">lambdify</tt> got merged
into SymPy's master branch: <a class="reference external" href="https://github.com/sympy/sympy/pull/13046">#13046</a>. We eventually decided
to drop the contents of the old translations dictionaries but leave
them be (in an empty state) in case users were modifying those in
their code. Hopefully this approach doesn't break any code out
there. Given how popular <tt class="docutils literal">lambdify</tt> is among SymPy's users, it is a
bit worrying that the test suite is not that extensive. I do remember
a google engineer mentioning that the follow the "Beyonce principle":
"I you liked it you should have put a test on it". Funny at is may be
I hope I don't need to defend these changes with that arguement.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/gsoc-week10.html" class="u-url">Status update week 10 GSoC</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Björn Dahlgren
            </span></p>
            <p class="dateline"><a href="posts/gsoc-week10.html" rel="bookmark"><time class="published dt-published" datetime="2017-08-07T21:03:00+02:00" title="2017-08-07 21:03">2017-08-07 21:03</time></a></p>
                <p class="commentline">
        
    <a href="posts/gsoc-week10.html#disqus_thread" data-disqus-identifier="cache/posts/170807-w10.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<div class="section" id="refactoring-lambdify">
<h2>Refactoring lambdify</h2>
<p>In my work to refactor <tt class="docutils literal">lambdify</tt> I had come up with a solution
where I would dynamically subclass the CodePrinters in <tt class="docutils literal">lambdify</tt> to
add translations from the old translation dictionaries. I was not
happy with the solution and I don't think Aaron was either, we decided
to keep the old import mechanism of lambdify which populated the
namespace (instead of trying to generate code for the used imports
which I had been trying).</p>
<p>So the work on refactoring <tt class="docutils literal">lambdify</tt> has continued in <a class="reference external" href="https://github.com/sympy/sympy/pull/13046">#13046</a>. And with <cite>this
&lt;https://github.com/sympy/sympy/commit/265314fa63f5a662a7a187913d51d55a852b503c&gt;</cite>
commit I hope we are close to getting the new version of <tt class="docutils literal">lambdify</tt>
out the door.</p>
</div>
<div class="section" id="new-floattype-representation">
<h2>New FloatType representation</h2>
<p>With some underlying assumptions about floating point representation
(two's complement etc.) I have now a <a class="reference external" href="https://github.com/sympy/sympy/commit/18ea9a583509f28bc88102e73ebff8e0443d7988">new representation</a>
of <tt class="docutils literal">FloatType</tt>. I'm much happier with this representation and I
think with it <a class="reference external" href="https://github.com/sympy/sympy/pull/12693">#12693</a> is
much closer to getting merged.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/gsoc-week8.html" class="u-url">Status update week 8 GSoC</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Björn Dahlgren
            </span></p>
            <p class="dateline"><a href="posts/gsoc-week8.html" rel="bookmark"><time class="published dt-published" datetime="2017-07-24T18:42:00+02:00" title="2017-07-24 18:42">2017-07-24 18:42</time></a></p>
                <p class="commentline">
        
    <a href="posts/gsoc-week8.html#disqus_thread" data-disqus-identifier="cache/posts/170724-w8.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <p>I finished up the new <tt class="docutils literal">PythonCodePrinter</tt> in <a class="reference external" href="https://github.com/sympy/sympy/pull/12808">#12808</a>. And I have started work
locally on having the NumPy- and Mpmath-printers subclass this new
CodePrinter. Both of these printers were previously subclassing
<tt class="docutils literal">LambdaPrinter</tt>, so the change is a bit intrusive with lots of
failing tests in the SymPy test suite. But this is a prerequisite for
changing <tt class="docutils literal">sympy.utilities.lambdify</tt> to accept custom <tt class="docutils literal">CodePrinter</tt>
subclasses as user input.</p>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/gsoc-week9.html" class="u-url">Status update week 9 GSoC</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Björn Dahlgren
            </span></p>
            <p class="dateline"><a href="posts/gsoc-week9.html" rel="bookmark"><time class="published dt-published" datetime="2017-07-24T18:42:00+02:00" title="2017-07-24 18:42">2017-07-24 18:42</time></a></p>
                <p class="commentline">
        
    <a href="posts/gsoc-week9.html#disqus_thread" data-disqus-identifier="cache/posts/170731-w9.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>This week has been mostly spent on two refactoring lambdify and
enhancing the representation of types in our AST nodes under <tt class="docutils literal">.codegen.ast</tt></p>
<div class="section" id="refactoring-lambdify">
<h2>Refactoring lambdify</h2>
<p>The tricky business of chaning <tt class="docutils literal">lambdify</tt> to use our new CodePrinter
(or more importantly: letting the user pass their own subclasses
continues).</p>
<p>There are currently dictionaries in <tt class="docutils literal">sympy.utilities.lambdify</tt> which
contains translations of SymPy entities to functions in corresponding
targeted python module (e.g. NumPy functions if the numpy module is
targeted). This week I've <a class="reference external" href="https://github.com/sympy/sympy/pull/13046">worked</a>
toward removing dependence on these,
and instead rely on the user providing print methods instead.</p>
</div>
<div class="section" id="work-on-types-in-codegen-ast">
<h2>Work on types in <tt class="docutils literal">.codegen.ast</tt>
</h2>
<p>In my <a class="reference external" href="https://github.com/sympy/sympy/pull/12693">WIP PR for AST nodes</a> I have made more type
related changes. I've also changed the Fortran printer to use the new
type information. I am not 100% satisfied with the way the floating
point types are being represented at the moment (I'm using floating
point numbers to store the max, min and epsilon values for example).
I will probably rewrite those classes to use the underlying number of
bits for mantissa and exponent as the canonical data for the class
instances.</p>
<p>I finished up the new <tt class="docutils literal">PythonCodePrinter</tt> in <a class="reference external" href="https://github.com/sympy/sympy/pull/12808">#12808</a>. And I have started work
locally on having the NumPy- and Mpmath-printers subclass this new
CodePrinter. Both of these printers were previously subclassing
<tt class="docutils literal">LambdaPrinter</tt>, so the change is a bit intrusive with lots of
failing tests in the SymPy test suite. But this is a prerequisite for
changing <tt class="docutils literal">sympy.utilities.lambdify</tt> to accept custom <tt class="docutils literal">CodePrinter</tt>
subclasses as user input.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/gsoc-week7.html" class="u-url">Status update week 7 GSoC</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Björn Dahlgren
            </span></p>
            <p class="dateline"><a href="posts/gsoc-week7.html" rel="bookmark"><time class="published dt-published" datetime="2017-07-17T08:32:00-05:00" title="2017-07-17 08:32">2017-07-17 08:32</time></a></p>
                <p class="commentline">
        
    <a href="posts/gsoc-week7.html#disqus_thread" data-disqus-identifier="cache/posts/170717-w7.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>This was an exciting week. I flew to Autstin, TX to attend the SciPy 2017 conference.
On Monday morning Aaron Meurer, Jason Moore, Kenneth Lyons and I gave our new tutorial
on code-generation. You can view the tutorial here:</p>
<p><a class="reference external" href="http://www.sympy.org/scipy-2017-codegen-tutorial/">http://www.sympy.org/scipy-2017-codegen-tutorial/</a></p>
<p>You can even follow along the tutorial video in a jupyter notebook in
your browser (thanks to the generous hosting by the folks at
<tt class="docutils literal">mybinder.org</tt>).</p>
<p>It was nice to see that quite a few people were using SymPy for
code-generation in the community. And coincidentally a proper Python
code printer was requested by some users (this is on my todo-list for
this summers project).</p>
<p>At the end of the conference there were also sprints, and SymPy did
sprint as well. For my project, the greatest benefit from the sprints
was that I got to discuss design choices wiht Aaron. We now have a
plan for how to deal with types in the code-printers, so now it is
"only" a matter of writing up the code to get it to work.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/gsoc-week6.html" class="u-url">Status update week 6 GSoC</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Björn Dahlgren
            </span></p>
            <p class="dateline"><a href="posts/gsoc-week6.html" rel="bookmark"><time class="published dt-published" datetime="2017-07-08T21:19:00+02:00" title="2017-07-08 21:19">2017-07-08 21:19</time></a></p>
                <p class="commentline">
        
    <a href="posts/gsoc-week6.html#disqus_thread" data-disqus-identifier="cache/posts/170708-w6.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<div class="section" id="finishing-up-tutorial-material">
<h2>Finishing up tutorial material</h2>
<p>We have been busy adding the final touches to the upcoming tutorial. (you can read
about the tutorial in ealier blog posts).</p>
<p>I thought I would share a technique for doing exercises in Jupyter notebooks.</p>
</div>
<div class="section" id="the-exercise-magic">
<h2>The %exercise magic</h2>
<p>There are quite a few ways to provide exercises in jupyter notebooks
(eventually I think there will be a de facto standard, either as a
separate package or included with the notebook itself). But I
essentially wanted a special version of <tt class="docutils literal">%load</tt> which would load a
file into a cell but replace some parts of the expressions with gaps
for the tutorial attendee to fill in.</p>
<p>Thanks to IPython being a popular project there was already <a class="reference external" href="https://stackoverflow.com/a/38103336/790973">a
solution</a>
posted on StackOverflow which did nearly exactly this.</p>
<p>After some tweaking I came up with this</p>
<pre class="code python"><a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-1"></a><span class="kn">import</span> <span class="nn">IPython.core.magic</span> <span class="kn">as</span> <span class="nn">ipym</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-2"></a>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-3"></a><span class="nd">@ipym.magics_class</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-4"></a><span class="k">class</span> <span class="nc">ExerciseMagic</span><span class="p">(</span><span class="n">ipym</span><span class="o">.</span><span class="n">Magics</span><span class="p">):</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-5"></a>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-6"></a>    <span class="nd">@ipym.line_magic</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-7"></a>    <span class="k">def</span> <span class="nf">exercise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-8"></a>        <span class="n">token</span> <span class="o">=</span> <span class="s1">'  # EXERCISE: '</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-9"></a>        <span class="n">out_lst</span> <span class="o">=</span> <span class="p">[]</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-10"></a>        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-11"></a>            <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ln</span><span class="p">:</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-12"></a>                <span class="n">pre</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-13"></a>                <span class="n">out_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">),</span> <span class="s1">'???'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-14"></a>            <span class="k">else</span><span class="p">:</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-15"></a>                <span class="n">out_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-16"></a>        <span class="n">out_str</span> <span class="o">=</span> <span class="s1">'# </span><span class="si">%e</span><span class="s1">xercise {0}</span><span class="se">\n</span><span class="s1">{1}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_lst</span><span class="p">))</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">set_next_input</span><span class="p">(</span><span class="n">out_str</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-18"></a>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-19"></a><span class="k">def</span> <span class="nf">load_ipython_extension</span><span class="p">(</span><span class="n">ipython</span><span class="p">):</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-20"></a>    <span class="n">ipython</span><span class="o">.</span><span class="n">register_magics</span><span class="p">(</span><span class="n">ExerciseMagic</span><span class="p">)</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-21"></a>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-22"></a><span class="k">def</span> <span class="nf">unload_ipython_extension</span><span class="p">(</span><span class="n">ipython</span><span class="p">):</span>
<a name="rest_code_3c1b85fc4cd649e2a6061f6618eb86e0-23"></a>    <span class="k">pass</span>
</pre>
<p>The downside of using this magic is that reloading the cell requires
the user to uncomment the <tt class="docutils literal"># %exercise ...</tt> line, delete the rest of
the cell and rerun it. This will only feel natural if you've already
worked with the <tt class="docutils literal">%load</tt> magic before (which in my humble opinion
is suboptimal since you often want bi-directional editing whenever you
pull out that magic).</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/gsoc-week5.html" class="u-url">Status update week 5 GSoC</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Björn Dahlgren
            </span></p>
            <p class="dateline"><a href="posts/gsoc-week5.html" rel="bookmark"><time class="published dt-published" datetime="2017-07-03T20:37:00+02:00" title="2017-07-03 20:37">2017-07-03 20:37</time></a></p>
                <p class="commentline">
        
    <a href="posts/gsoc-week5.html#disqus_thread" data-disqus-identifier="cache/posts/170703-w5.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<div class="section" id="continued-work-on-tutorial-material">
<h2>Continued work on tutorial material</h2>
<p>Cross-platform work is always a bit tricky. Python does in general
a great job of allowing programs to access the filesystem, network etc
in an OS agnostic manner, but sometimes there is no way around having
to write special code for each platform. In Python that often means
that we will do runtime inspection:</p>
<pre class="literal-block">
&gt;&gt;&gt; sys.platform
'linux'  # or e.g. darwin
&gt;&gt;&gt; os.name
'posix'  # or e.g. nt
</pre>
<p>To add another dimension of complexity we sometimes deal with 32-bit
and sometimes 64-bit systems (most headaches are caused by pointer
sizes, size of <tt class="docutils literal">int</tt> and <tt class="docutils literal">long</tt>), in python we can get the size of
<tt class="docutils literal">int</tt> of the platform quite easily:</p>
<pre class="literal-block">
&gt;&gt;&gt; sys.maxsize - 2**63 + 1
0
</pre>
<p>when you, in addition to this, are doing code-generation, you are most
likely relying on a compiler. That is our third dimension of
complexity, on linux that (usually) translates to gcc &amp; llvm/clang
(but Intel's icc/ifort &amp; portland group compilers and not uncommon).
This third "dimension" has been the number one struggle the past
week (and in particular the <a class="reference external" href="https://github.com/sympy/scipy-2017-codegen-tutorial/issues/13">combination</a>
mingw/<a class="reference external" href="https://github.com/sympy/scipy-2017-codegen-tutorial/pull/14">windows</a>). At
this point I feel that it is not worthwhile to continue pursuing <tt class="docutils literal">mingw</tt>
support on Windows.</p>
<p>It is quite likely that a few of our attendees will have some
technical difficulties with system installed compilers. Therefore, I'm
particularly happy that we now have got our <a class="reference external" href="https://mybinder.org">binder</a> environment to work flawlessly. It took some
work to setup a <a class="reference external" href="https://github.com/sympy/scipy-2017-codegen-tutorial/blob/master/Dockerfile">Dockerfile</a>,
but now it feels reassuring to have this as a fall-back.</p>
</div>
<div class="section" id="work-on-sympy-for-version-1-1">
<h2>Work on SymPy for version 1.1</h2>
<p>The <a class="reference external" href="https://github.com/sympy/sympy/pull/12808">work</a> on the
<tt class="docutils literal">PythonCodePrinter</tt> has progressed since last week and should
hopefully soon be ready for merging. The purpose of this class is to
be stepping stone moving away from having e.g. <tt class="docutils literal">lambdify</tt> relying on
the StrPrinter, and instead use the <tt class="docutils literal">CodePrinter</tt> class in
<tt class="docutils literal">.printing.codeprinter</tt>. Changing the super class showed to be
trickier than first anticipiated (I thought it would be an afternoons
work at most). I originally planned to rename the original
<tt class="docutils literal">PythonPrinter</tt> to something more appropriate (<tt class="docutils literal">SymPyCodePrinter</tt>)
together with its convenience functions. However, since this would
incur a deprecation for only name change, it was decided that we will
have to live with the old naming (to avoid raising tons of deprecation
warnings in downstream projects).</p>
<p>We had identified two extensions we wanted to introduce to the
codegeneration/autowrap factilities before the v1.1 release:</p>
<ul class="simple">
<li>Kenneth Lyons (@ixjlyons) <a class="reference external" href="https://github.com/sympy/sympy/pull/12833">spear-headed</a> the effort to allow
custom CodeGen subclasses to be passed to <tt class="docutils literal">codegen</tt>
</li>
<li>...and Jason the <a class="reference external" href="https://github.com/sympy/sympy/pull/12843">changes</a> to the
<tt class="docutils literal">CythonWrapper</tt> to allow compiler arguments to be passed to
autowrap.</li>
</ul>
</div>
<div class="section" id="plans-for-the-upcoming-week">
<h2>Plans for the upcoming week</h2>
<p>With a release candidate of SymPy v1.1 out the door (an impressive
effort led by @asmeurer) and most cross-platform issues out of the
way, it is about time for the final iterations of the  tutorial
material (and hopefully iron out any related issues in the rc).</p>
<p>At the end of the week it's time for me to fly to the US to attend
SciPy 2017. I have high expectations and believe that it will be a
great catalyst for the rest of the summers work on code-generation.</p>
</div>
</div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="next">
                <a href="index-1.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="bjodahgithubio";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2017         <a href="mailto:bjodah@gmail.com">Björn Dahlgren</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="assets/js/jquery.min.js"></script><script src="assets/js/bootstrap.min.js"></script><script src="assets/js/moment-with-locales.min.js"></script><script src="assets/js/fancydates.js"></script><script src="assets/js/jquery.colorbox-min.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
