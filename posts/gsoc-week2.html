<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Second week of developing code-generation in SymPy for GSoC.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Status update week 2 GSoC | Björn I. Dahlgren's personal page</title>
<link href="../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../assets/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">
<link rel="canonical" href="http://bjodah.github.io/blog/posts/gsoc-week2.html">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]--><meta name="author" content="Björn Dahlgren">
<link rel="prev" href="gsoc-week1.html" title="A summer of code and mathematics" type="text/html">
<meta property="og:site_name" content="Björn I. Dahlgren's personal page">
<meta property="og:title" content="Status update week 2 GSoC">
<meta property="og:url" content="http://bjodah.github.io/blog/posts/gsoc-week2.html">
<meta property="og:description" content="Second week of developing code-generation in SymPy for GSoC.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-06-11T23:37:00+02:00">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="SymPy">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://bjodah.github.io/blog/">

                <span id="blog-title">Björn I. Dahlgren's personal page</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../archive.html">Archive</a>
                </li>
<li>
<a href="../categories/index.html">Tags</a>
                </li>
<li>
<a href="../rss.xml">RSS feed</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="gsoc-week2.rst" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Status update week 2 GSoC</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    Björn Dahlgren
            </span></p>
            <p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2017-06-11T23:37:00+02:00" itemprop="datePublished" title="2017-06-11 23:37">2017-06-11 23:37</time></a></p>
                <p class="commentline">
        
    <a href="gsoc-week2.html#disqus_thread" data-disqus-identifier="cache/posts/170611-gsoc-w2.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="gsoc-week2.rst" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>I have spent the second week of Google Summer of Code on essentially two things:</p>
<ol class="arabic simple">
<li>Continued work on type awareness in the code printers (<tt class="docutils literal">CCodePrinter</tt> and
<tt class="docutils literal">FCodePrinter</tt>). The work is ongoing in <a class="reference external" href="https://github.com/sympy/sympy/pull/12693">gh-12693</a>.</li>
<li>Writing tutorial <a class="reference external" href="https://github.com/sympy/scipy-2017-codegen-tutorial">code</a> on code-generation in the form of jupyter notebooks for the
upcoming SciPy 2017 <a class="reference external" href="https://scipy2017.scipy.org/ehome/220975/493418/">conference</a>.</li>
</ol>
<div class="section" id="precision-aware-code-printers">
<h2>Precision aware code printers</h2>
<p>After my weekly mentor meeting, we decided to take another approach to
how we are going to represent <tt class="docutils literal">Variable</tt> instances in the
<tt class="docutils literal">.codegen.ast</tt> module. Previously I had proposed to use quite a
number of arguments (stored in <tt class="docutils literal">.args</tt> since it inherits
<tt class="docutils literal">Basic</tt>). Aaron suggested we might want to represent that underlying
information differently. After some discussion we came to the
conclusion that we could introduce a <tt class="docutils literal">Attribute</tt> class (inhereting
from <tt class="docutils literal">Symbol</tt>) to describe things such as value const-ness, and
pointer const-ness (those two are available as <tt class="docutils literal">value_const</tt> and
<tt class="docutils literal">pointer_const</tt>). Attributes will be stored in a <tt class="docutils literal">FiniteSet</tt>
(essentially SymPy version of <tt class="docutils literal">set</tt>) and the instances we provide as
"pre-made" in the <tt class="docutils literal">.codegen.ast</tt> module will be supported by the
printers by default. Here is some example code showing what the
current proposed API looks like (for C99):</p>
<pre class="literal-block">
&gt;&gt;&gt; u = symbols('u', real=True)
&gt;&gt;&gt; ptr = Pointer.deduced(u, {pointer_const, restrict})
&gt;&gt;&gt; ccode(Declaration(ptr))
'double * const restrict u;'
</pre>
<p>and for Fortran:</p>
<pre class="literal-block">
&gt;&gt;&gt; vx = Variable(Symbol('x'), {value_const}, float32)
&gt;&gt;&gt; fcode(Declaration(vx, 42))
'real(4), parameter :: x = 42'
</pre>
<p>The C code printer can now also print code using different math functions depending
on the targeted precision (functions guaranteed to be present in the C99 stanard):</p>
<pre class="literal-block">
&gt;&gt;&gt; ccode(x**3.7, standard='c99', precision=float32)
'powf(x, 3.7F)'
&gt;&gt;&gt; ccode(exp(x/2), standard='c99', precision=float80)
'expl((1.0L/2.0L)*x)'
</pre>
</div>
<div class="section" id="tutorial-material-for-code-generation">
<h2>Tutorial material for code generation</h2>
<p>Aaron, Jason and I have been discussing what examples to use for the
tutorial on code generation with SymPy. Right now we are aiming to use
quite a few examples from chemistry actually, and more specifically
<a class="reference external" href="https://en.wikipedia.org/wiki/Chemical_kinetics">chemical kinetics</a>. This is the
precise application which got me started using SymPy for
code-generation, so it lies close to my heart (I do extensive modeling
of chemical kinetics in my PhD studies).</p>
<p>Working on the tutorial material has already been really helpful for
getting insight in development needs for the exisiting classes and
functions used for code-generation. I was hoping to use <tt class="docutils literal">autowrap</tt>
from the <tt class="docutils literal">.utilities</tt> module. Unfortunately I found that it was not
flexible enough to be useful for integration of systems of ODEs (where
we need to evaluate a vector-valued function taking a vector as
input). I did attempt to subclass the <tt class="docutils literal">CodeWrapper</tt> class to allow
me to do this. But personally I found those classes to be quite hard to
extend (much unlike the printers which I've often found to be
intuitive).</p>
<p>My current plan for the chemical kinetics case is to first solve it
using <tt class="docutils literal">sympy.lambdify</tt>.  That allows for quick prototyping, and
unless one has very high demands with respect to performance, it is
usually good enough.</p>
<p>The next step is to generate a native callback (it was here I was
hoping to use <tt class="docutils literal">autowrap</tt> with the Cython backend). The current
approach is to write the expressions as Cython code using a template.
Cython conveniently follows Python syntax, and hence the string
printer can be used for the code generation. Doing this speeds up the
integration considerably. At this point the bottleneck is going back and
forth through the Python layer.</p>
<p>So in order to speed up the integration further, we need to bypass
Python during integration (and let the solver call the user
provided callbacks without going through the interpreter). I did
this by providing a C-code template which relies on <tt class="docutils literal">CVode</tt> from the
<a class="reference external" href="https://computation.llnl.gov/projects/sundials">Sundials</a> suite of
non-linear solvers. It is a well established solver and is already
available for Linux, Mac &amp; Windows under conda from the
<tt class="docutils literal"><span class="pre">conda-forge</span></tt> channel. I then provide a thin Cython wrapper, calling
into the C-function, which:</p>
<ol class="arabic simple">
<li>sets up the CVode solver</li>
<li>runs the integration</li>
<li>records some statistics</li>
</ol>
<p>Using native code does come at a cost. One of the strengths of Python
is that it is cross-platform. It (usually) does not matter if your
Python application runs on Linux, OSX or Windows (or any other
supported operating system). However, since we are doing
code-generation, we are relying on compilers provided by the
respective platform. Since we want to support both Python 2 &amp; Python 3
on said three platforms, there are quite a few combinations to cover.
That meant quite a few surprises (I now know for example that MS
Visual C++ 2008 does not support C99), but thanks to the kind <a class="reference external" href="https://github.com/sympy/scipy-2017-codegen-tutorial/issues/2#issuecomment-307538308">help</a> of
<a class="reference external" href="https://github.com/isuruf">Isuru Fernando</a> I think I will manage to
have all platform/version combinations working during next week.</p>
<p>Also planned for next week:</p>
<ul class="simple">
<li>Use <tt class="docutils literal">numba</tt> together with <tt class="docutils literal">lambdify</tt>
</li>
<li>Use <tt class="docutils literal">Lambdify</tt> from <a class="reference external" href="https://github.com/symengine">SymEngine</a>
(preferably with the LLVM backend).</li>
<li>Make the notebooks more tutorial like (right now they are more of a
show-case).</li>
</ul>
<p>and of course: continued work on the code printers. That's all for now
feel free to get in touch with any feedback or questions.</p>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../categories/python.html" rel="tag">Python</a></li>
            <li><a class="tag p-category" href="../categories/sympy.html" rel="tag">SymPy</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="gsoc-week1.html" rel="prev" title="A summer of code and mathematics">Previous post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="bjodahgithubio",
            disqus_url="http://bjodah.github.io/blog/posts/gsoc-week2.html",
        disqus_title="Status update week 2 GSoC",
        disqus_identifier="cache/posts/170611-gsoc-w2.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="bjodahgithubio";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2017         <a href="mailto:bjodah@gmail.com">Björn Dahlgren</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../assets/js/jquery.min.js"></script><script src="../assets/js/bootstrap.min.js"></script><script src="../assets/js/moment-with-locales.min.js"></script><script src="../assets/js/fancydates.js"></script><script src="../assets/js/jquery.colorbox-min.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
